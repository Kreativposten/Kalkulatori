{% extends "layout.html" %}

{% block title %}Auftragsliste - Print Manager{% endblock %}

{% block content %}
<style>
    .main-content-padded { 
        padding: 2rem; 
        box-sizing: border-box;
    }
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    .page-header h1 {
        margin: 0;
    }
    .filter-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .filter-bar input[type="text"], .filter-bar select {
        padding: 0.75rem;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        font-size: 1rem;
    }
    .filter-bar input[type="text"] {
        flex-grow: 1;
    }
    .table-container { 
        background-color: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    .auftrags-tabelle {
        width: 100%;
        border-collapse: collapse;
    }
    .auftrags-tabelle th, .auftrags-tabelle td {
        padding: 1rem 1.5rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }
    .auftrags-tabelle thead {
        background-color: #f8f9fa;
    }
    .auftrags-tabelle tbody tr:hover {
        background-color: #f1f5f9;
    }
    .auftrags-tabelle .status-badge {
        display: inline-block;
        padding: 0.25em 0.6em;
        font-size: 0.85em;
        font-weight: 600;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.375rem;
        color: #fff;
    }
    .status-entwurf { background-color: #6c757d; }
    .status-angebot { background-color: #17a2b8; }
    .status-vorbereitung { background-color: #ffc107; color: #212529; }
    .status-produktion { background-color: #fd7e14; }
    .status-abgeschlossen { background-color: #28a745; }
    .btn { 
        display: inline-block; font-weight: 500; color: #fff; text-align: center; cursor: pointer; 
        background-color: #007bff; border: 1px solid #007bff; 
        padding: .375rem .75rem; font-size: 0.9rem; border-radius: .25rem; text-decoration: none; 
    }
</style>

<div class="main-content-padded">
    <div class="page-header">
        <h1>Auftragsliste</h1>
    </div>

    <div class="filter-bar">
        <input type="text" id="search-input" placeholder="Suche nach Auftrags-Nr oder Kunde...">
        <select id="status-filter">
            <option value="">Alle Status</option>
            <option value="Entwurf">Entwurf</option>
            <option value="Angebot an Kunden gesendet">Angebot an Kunden gesendet</option>
            <option value="Auftrag angenommen">Auftrag angenommen</option>
            <option value="Warten auf Korrektur-Freigabe">Warten auf Korrektur-Freigabe</option>
            <option value="In Produktion">In Produktion</option>
            <option value="Abholbereit">Abholbereit</option>
            <option value="Abgeschlossen">Abgeschlossen</option>
        </select>
    </div>
    
    <div class="table-container">
        <table class="auftrags-tabelle">
            <thead>
                <tr>
                    <th>Auftrags-Nr.</th>
                    <th>Kunde</th>
                    <th>Datum</th>
                    <th>Status</th>
                    <th>Aktion</th>
                </tr>
            </thead>
            <tbody id="auftrags-tbody">
                <tr>
                    <td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                        Aufträge werden geladen...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    let alleProjekte = [];

    function getStatusColorClass(status) {
        const lowerStatus = status.toLowerCase();
        if (lowerStatus === 'entwurf') return 'status-entwurf';
        if (lowerStatus.includes('angebot')) return 'status-angebot';
        if (lowerStatus.includes('angenommen') || lowerStatus.includes('freigabe') || lowerStatus.includes('warte')) return 'status-vorbereitung';
        if (lowerStatus.includes('produktion') || lowerStatus.includes('abholbereit')) return 'status-produktion';
        if (lowerStatus.includes('abgeschlossen')) return 'status-abgeschlossen';
        return 'status-entwurf';
    }

    function renderTabelle(projekte) {
        const tbody = document.getElementById('auftrags-tbody');
        tbody.innerHTML = '';

        if (projekte.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-secondary);">Keine Aufträge gefunden, die den Kriterien entsprechen.</td></tr>';
            return;
        }

        projekte.forEach(p => {
            const tr = document.createElement('tr');
            
            let aktionenHtml = `<a href="/auftrag/${p.id}" class="btn">Ansehen</a>`;
            if (p.status === 'Entwurf' || p.status.includes('Angebot')) {
                 aktionenHtml = `<a href="/kalkulator?load_id=${p.id}" class="btn">Bearbeiten</a>`;
            }

            tr.innerHTML = `
                <td>${p.angebot_nr}</td>
                <td>${p.kunde_name || 'N/A'}</td>
                <td>${p.datum}</td>
                <td><span class="status-badge ${getStatusColorClass(p.status)}">${p.status}</span></td>
                <td>${aktionenHtml}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function filterUndRendern() {
        const suchbegriff = document.getElementById('search-input').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;

        const gefilterteProjekte = alleProjekte.filter(p => {
            const kundeMatch = p.kunde_name && p.kunde_name.toLowerCase().includes(suchbegriff);
            const nummerMatch = p.angebot_nr.toLowerCase().includes(suchbegriff);
            const statusMatch = !statusFilter || p.status === statusFilter;

            return (kundeMatch || nummerMatch) && statusMatch;
        });

        renderTabelle(gefilterteProjekte);
    }

    async function ladeProjekte() {
        try {
            const response = await fetch('/get-projekte');
            alleProjekte = await response.json();
            filterUndRendern();
        } catch (error) {
            const tbody = document.getElementById('auftrags-tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="padding: 2rem; text-align: center; color: #dc3545;">Fehler beim Laden der Aufträge.</td></tr>';
            console.error('Fehler:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('search-input').addEventListener('input', filterUndRendern);
        document.getElementById('status-filter').addEventListener('change', filterUndRendern);
        ladeProjekte();
    });
</script>
{% endblock %}
